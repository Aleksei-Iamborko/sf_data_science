---
title: "HW_5_Iamborko"
author: "Aleksei Iamborko"
date: "2024-04-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Задание 1
Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).
Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.
```{r}
library(ggplot2)
library(dplyr)
library(survminer)

# полный путь к файлу CSV на компьютере
file_path <- "C:/Dir/wisconsin_breast_cancer.csv"

# Загрузка датасета
data <- read.csv(file_path)

# Просмотр первых строк данных
head(data)

# Создание регрессионной модели
model <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = data)

# Построение графиков
# График для переменной radius_mean и area_mean
ggplot(data, aes(x = area_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x, color = 'blue') +
  labs(title = 'Связь между radius_mean и area_mean', x = 'area_mean', y = 'radius_mean')

# График для переменной radius_mean и perimeter_mean
ggplot(data, aes(x = perimeter_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x, color = 'red') +
  labs(title = 'Связь между radius_mean и perimeter_mean', x = 'perimeter_mean', y = 'radius_mean')

# График для переменной radius_mean и symmetry_mean
ggplot(data, aes(x = symmetry_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = y ~ x, color = 'green') +
  labs(title = 'Связь между radius_mean и symmetry_mean', x = 'symmetry_mean', y = 'radius_mean')
```

# Вывод: 
1. График для переменных radius_mean и area_mean показывает, что с увеличением значения area_mean увеличивается и значение radius_mean. Регрессионная прямая подтверждает положительную зависимость между этими переменными.
2. На графике для переменных radius_mean и perimeter_mean также наблюдается положительная зависимость — 
с увеличением значения perimeter_mean растет и значение radius_mean. Регрессионная прямая подтверждает данную зависимость.Здесь отмечается наиболее точное распределение точек по регрессионной прямой.
3. График для переменных radius_mean и symmetry_mean может показать менее четкую зависимость, поскольку распределение точек выглядит более разбросанным (имеется некоторое количество выбросов). 
Однако регрессионная прямая указывает на некоторую положительную зависимость между этими переменными.

В целом, результаты анализа графиков позволяют сделать вывод о существовании положительной зависимости переменной radius_mean от переменных area_mean, perimeter_mean, а также о некоторой зависимости от переменной symmetry_mean. Данная модель поможет описать взаимозависимость между этими признаками и может быть использована для прогнозирования значений радиуса опухоли на основе других характеристик.

# Задание 2
Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).
Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.
```{r}
# Преобразование колонки diagnosis в числовой формат (злокачественная = 1, доброкачественная = 0)
data$diagnosis <- ifelse(data$diagnosis == "M", 1, 0)

# Создание модели логистической регрессии для 3 факторов
model <- glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = data, family = binomial)
summary(model)

#1. Модель с одним фактором radius_mean:
model_radius <- glm(diagnosis ~ radius_mean, data = data, family = "binomial")
summary(model_radius)

#2. Модель с одним фактором area_mean:
model_area <- glm(diagnosis ~ area_mean, data = data, family = "binomial")
summary(model_area)

# 3. Модель с одним фактором texture_mean:
model_texture <- glm(diagnosis ~ texture_mean, data = data, family = "binomial")
summary(model_texture)

# Построение графиков
# График для переменной radius_mean
ggplot(data, aes(x = radius_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = 'glm', method.args = list(family = 'binomial'), se = FALSE) +
  labs(title = 'Вероятность злокачественной опухоли от radius_mean')

# График для переменной area_mean
ggplot(data, aes(x = area_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = 'glm', method.args = list(family = 'binomial'), se = FALSE) +
  labs(title = 'Вероятность злокачественной опухоли от area_mean')

# График для переменной texture_mean
ggplot(data, aes(x = texture_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = 'glm', method.args = list(family = 'binomial'), se = FALSE) +
  labs(title = 'Вероятность злокачественной опухоли от texture_mean')
```

# Задание 3 
Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.
Датасет содержит следующий набор переменных:
inst: код учреждения;
time: время выживаемости в днях;
status: 1 = цензурирование, 2 = смерть;
age: возраст в годах;
sex: мужской = 1, женский = 2;
ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
meal.cal: калории потребляемой пищи;
wt.loss: потеря веса за последние полгода.
Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.
Изучите работу функций Surv(), survfit() и ggsurvplot():
Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?
```{r}
library(survival)
# Загрузка датасета lung
lung <- lung

# Создание переменной event
lung$event <- ifelse(lung$status == 2, 1, 0)

# Просмотр первых строк нового датасета
head(lung)

# Создание объекта выживаемости
surv_obj <- Surv(time = lung$time, event = lung$event)

# Построение кривых выживаемости по полу
surv_fit <- survfit(surv_obj ~ lung$sex)

# Построение графика выживаемости
ggsurvplot(surv_fit, data = lung, risk.table = TRUE, pval = TRUE)
```
## Вывод: 
значение p-value в результате лог-рангового теста (0,0013) указывает на статистическую значимость различий в выживаемости между группами (по полу в данном случае). Чем меньше значение p-value, тем сильнее статистическая разница между группами. В данном случае значение p-value равное 0,0013 гораздо меньше стандартного уровня значимости 0,05, что означает, что различия в выживаемости между мужчинами и женщинами статистически значимы.Из полученных результатов можно сделать вывод, что пол пациента оказывает влияние на выживаемость в данной выборке пациентов с раком легких. На графике кривых выживаемости вы можете увидеть, как выживаемость меняется в зависимости от пола. Если кривые выживаемости значительно различаются между группами, это может указывать на то, что пол является важным фактором в прогнозировании выживаемости пациентов.Таким образом, значение p-value 0,0013 указывает на статистически значимые различия в выживаемости между мужчинами и женщинами с раком легких в данном наборе данных.
```{r}
# Создание факторного столбца для пола
lung$sex_factor <- as.factor(lung$sex)

# Построение кумулятивной функции рисков по полу
fit <- survfit(surv_obj ~ sex_factor, data = lung)
cumhaz <- fit$cumhaz

# Построение графика кумулятивной функции рисков
ggsurvplot(fit, data = lung)
```
# Выводы: 
На графике видно две кривые: одна для мужчин, другая для женщин. Прослеживается, что у женщин начальная вероятность смерти выше, чем у мужчин, но затем кривые со временем пересекаются. Динамика, которую можно проследить, это как изменяется риск смерти во времени и есть ли какие-то переломные моменты, когда одна группа становится более уязвимой.Также стоит обратить внимание на степень разброса данных вокруг кривых и наличие доверительных интервалов. Это позволяет сделать выводы о статистической значимости различий между группами.Таким образом, график позволяет оценить, как пол влияет на вероятность смерти от рака легких и как эта вероятность меняется во времени. Подробный статистический анализ может помочь подтвердить гипотезу о различиях между группами.
```{r}
# Построим регрессию Кокса
cox_model <- coxph(Surv(time, status) ~ sex_factor, data = lung)

# Выведем результаты анализа
summary(cox_model)
```
## Рассмотрим полученные результаты анализа регрессии Кокса для фактора "sex_factor" (пола) на выживаемость пациентов с раком легких:

1. Коэффициент для переменной sex_factor2 составляет -0.5310. Это означает, что у женщин наблюдается снижение величины риска смерти (exp(coef) = 0.588) по сравнению с мужчинами.
2. P-значение для коэффициента равно 0.00149, что намного меньше стандартного уровня значимости 0.05. Это говорит о том, что влияние пола на выживаемость пациентов с раком легких статистически значимо.
3. Значение Concordance равно 0.579. Это представляет собой меру согласованности между наблюдаемыми результатами и результатами, предсказанными моделью выживаемости. Чем ближе это значение к 1, тем лучше модель предсказывает выживаемость.
4. Логарифмический тест отношения правдоподобия, тест Уолда и тест лог-ранка также показывают статистически значимую связь между полом и выживаемостью.

Таким образом, на основе этих результатов можно сделать вывод, что пол оказывает влияние на выживаемость пациентов с раком легких, причем у женщин статистически значимо выше вероятность выживания, чем у мужчин.